
<!-- R1 -->
<div class="row">

  <!-- R1C1 -->
  <div class="col-md-6 col-xs-12">

    <span style="display: block;">
      <uib-pagination items-per-page="pageSize" max-size="5"
        boundary-links="true" class="pagination-sm" previous-text="&lsaquo;"
        next-text="&rsaquo;" first-text="&laquo;" last-text="&raquo;"
        ng-show="refsets.totalCount > pageSize || paging['refset'].filter"
        total-items="refsets.totalCount" ng-model="paging['refset'].page"
        ng-change="getRefsets()"></uib-pagination>

      <input class="input-filter" placeholder="Enter filter text"
        ng-show="refsets.totalCount > pageSize || paging['refset'].filter"
        type="text" ng-model="paging['refset'].filter"
        ng-model-options="{ debounce: 300 }" ng-change="getRefsets()">

      <button class="btn btn-xs btn-warning" ng-show="paging['refset'].filter"
        ng-click="paging['refset'].filter = ''; getRefsets()"
        title="Click to clear filter text">Clear</button>

      <h4 ng-show="value == 'AVAILABLE' && refsets.totalCount == 0">
        <div style="float: right;">
          <i ng-click="openAddRefsetModal()" title="Add refset"
            class="noul material-icons md-24">add</i>
        </div>
      </h4>
    </span>

    <!-- Basic Refset info -->
    <span ng-show="refsets.totalCount == 0" style="display: block;"
      class="alert alert-warning">No refsets.</span>

    <table ng-show="refsets.totalCount > 0" class="table">
      <thead class="table-select-row">
        <th class="col-md-2 col-xs-2"
          ng-click="setSortField('refset','terminologyId', null)">Refset Id<span
            ng-bind="getSortIndicator('refset','terminologyId')"></span>
        </th>
        <th class="col-md-4 col-xs-4"><span
            ng-click="setSortField('refset','name', null)">
            Name
            <span ng-bind="getSortIndicator('refset','name',null)"></span>
          </span> <span
            ng-show="value == 'PUBLISHED' || value == 'PREVIEW' || value == 'RELEASE'">
            <span ng-click="setSortField('refset','effectiveTime', null)">
              Effective Time
              <span ng-bind="getSortIndicator('refset','effectiveTime',null)"></span>
            </span>
          </span></th>
        <th class="col-md-3 col-xs-3"
          ng-click="setSortField('refset','moduleId', null)">Module<span
            ng-bind="getSortIndicator('refset','moduleId',null)"></span></th>
        <th class="col-md-1 col-xs-1"
          ng-click="setSortField('refset','type', null)">Type<span
            ng-bind="getSortIndicator('refset','type',null)"></span></th>
        <!-- Actions header -->
        <th class="col-md-2 col-xs-2"
          ng-show="value == 'AVAILABLE' || value == 'ASSIGNED' || value == 'ASSIGNED_ALL' || value == 'RELEASE'">Actions
          <span style="float: right;">
            <i ng-click="openAddRefsetModal()" title="Add refset"
              class="noul material-icons md-18">add</i>
          </span>
        </th>
        <th class="col-md-2 col-xs-2"
          ng-show="userProjectsInfo.anyRole && (value == 'PUBLISHED' || value == 'PREVIEW')">Actions
        </th>

      </thead>
      <tbody>
        <tr ng-repeat="refset in refsets" ng-click="selectRefset(refset);"
          ng-class="{selected: refset.id == selected.refset.id}">
          <td style="word-break: break-word;">{{refset.terminologyId}}</td>
          <td>
            {{refset.name}}
            <span ng-show="refset.effectiveTime">
              <br />{{toShortDate(refset.effectiveTime)}}
            </span>
          </td>
          <td>
            {{refset.moduleId}}
            <!-- Mobile friendly line-break -->
            <br class="visible-xs-inline" />
            <span flag-icon obj="refset"></span>
            <!-- Mobile friendly line-break -->
            <br class="visible-xs-inline" /> {{refset.organization}}
            <span
              ng-show="value == 'AVAILABLE' || value == 'ASSIGNED' || value == 'ASSIGNED_ALL' || value == 'RELEASE'">
              <br />{{refset.workflowStatus}}
            </span>
          </td>
          <td>
            <span refset-type-icon refset="refset"></span>
          </td>

          <!-- PUBLISHED/PREVIEW actions -->
          <td class="nobreak"
            ng-show="userProjectsInfo.anyRole && (value == 'PUBLISHED' || value == 'PREVIEW')">
            <i ng-click="openCloneRefsetModal(refset); $event.stopPropagation()"
              ng-show="userProjectsInfo.anyRole" title="Clone"
              class="noul material-icons md-18">content_copy</i>
            <i ng-click="openFeedbackModal(refset); $event.stopPropagation()"
              title="Submit feedback" class="noul material-icons md-18">speaker_notes</i>
          </td>

          <!-- AVAILABLE actions -->
          <td class="nobreak" ng-show="value == 'AVAILABLE'">
            <i title="Remove"
              ng-click="removeRefset(refset); $event.stopPropagation()"
              class="noul material-icons md-18">delete</i>
            <i ng-show="projects.role != 'ADMIN'"
              ng-click="openAssignRefsetModal(refset, 'ASSIGN', user.userName); $event.stopPropagation()"
              title="Assign" class="noul material-icons md-18">assignment</i>
            <i ng-show="projects.role != 'ADMIN'"
              ng-click="openCloneRefsetModal(refset); $event.stopPropagation()"
              title="Clone" class="noul material-icons md-18">content_copy</i>
            <!-- ASSIGNED_ALL actions -->
          <td class="nobreak" ng-show="value == 'ASSIGNED_ALL'">

            <i ng-click="removeRefset(refset); $event.stopPropagation()"
              title="Remove" class="noul material-icons md-18">delete</i>

            <span ng-repeat="author in refsetAuthorsMap[refset.id]">
              <!-- Only unassign if there are no reviewers -->
              <i ng-show="refsetReviewersMap[refset.id].length == 0"
                uib-tooltip="Unassign author: {{author.userName}}"
                ng-click="performWorkflowAction(refset, 'UNASSIGN', author.userName); $event.stopPropagation()"
                class="noul material-icons md-18">assignment_return</i>
              <i ng-show="refsetReviewersMap[refset.id].length > 0"
                uib-tooltip="Unassign author: {{author.userName}}"
                class="md-grey material-icons md-18">assignment_ind</i>
            </span>
            <span ng-repeat="reviewer in refsetReviewersMap[refset.id]">
              <i uib-tooltip="Unassign reviewer: {{reviewer.userName}}"
                ng-click="performWorkflowAction(refset, 'UNASSIGN', reviewer.userName); $event.stopPropagation()"
                class="noul material-icons md-18">assignment_return</i>
            </span>

          </td>

          <!-- ASSIGNED actions -->
          <td class="nobreak" ng-show="value == 'ASSIGNED'">
            <i ng-click="openEditRefsetModal(refset); $event.stopPropagation()"
              title="Edit" class="noul material-icons md-18">edit</i>
            <i ng-click="removeRefset(refset); $event.stopPropagation()"
              title="Remove" class="noul material-icons md-18">delete</i>
            <i
              ng-click="performWorkflowAction(refset, 'UNASSIGN', user.userName); $event.stopPropagation()"
              title="Unassign" class="noul material-icons md-18">assignment_return</i>
            <i ng-show="projects.role == 'REVIEWER'"
              ng-click="performReassign(refset); $event.stopPropagation()"
              title="Reassign" class="noul material-icons md-18">assignment_returned</i>
            <i
              ng-click="performWorkflowAction(refset, 'SAVE', user.userName); $event.stopPropagation()"
              title="Save" class="noul material-icons md-18">save</i>
            <i ng-show="refset.workflowStatus != 'REVIEW_DONE'"
              ng-click="performWorkflowAction(refset, 'FINISH', user.userName); $event.stopPropagation()"
              title="Finish" class="noul material-icons md-18">done</i>
            <i ng-show="refset.workflowStatus == 'REVIEW_DONE'"
              ng-click="performWorkflowAction(refset, 'FINISH', user.userName); $event.stopPropagation()"
              title="Mark ready for publication"
              class="noul material-icons md-18">open_in_new</i>

            <span ng-show="refset.stagingType == 'IMPORT'">
              <br />
              <button class="btn btn-xs btn-warning"
                ng-click="cancelAction(refset)"
                uib-tooltip="Click to cancel failed import">Cancel
                Import</button>
            </span>
            <span ng-show="refset.stagingType == 'DEFINITION'">
              <br />
              <button class="btn btn-xs btn-warning"
                ng-click="cancelAction(refset)"
                uib-tooltip="Click to cancel redefinition">Cancel
                Redefinition</button>
            </span>
            <span ng-show="refset.stagingType == 'MIGRATION'">
              <br />
              <button class="btn btn-xs btn-warning"
                ng-click="cancelAction(refset)"
                uib-tooltip="Click to cancel migration">Cancel
                Migration</button>
            </span>
          </td>

          <!-- RELEASE actions -->
          <td class="nobreak" ng-show="value == 'RELEASE'">

            <i
              ng-show="refset.workflowStatus == 'PUBLISHED' || refset.workflowStatus == 'READY_FOR_PUBLICATION'"
              ng-click="removeRefset(refset); $event.stopPropagation()"
              title="Remove" class="noul material-icons md-18">delete</i>

            <i
              ng-show="projects.role != 'ADMIN' && refset.workflowStatus == 'READY_FOR_PUBLICATION'"
              ng-click="openAssignRefsetModal(refset, 'ASSIGN', user.userName); $event.stopPropagation()"
              title="Assign" class="noul material-icons md-18">assignment</i>

            <!-- only if READY_FOR_PUBLICATION -->

            <i
              ng-show="refset.workflowStatus == 'READY_FOR_PUBLICATION' && !refset.inPublicationProcess"
              ng-click="openReleaseProcessModal(refset); $event.stopPropagation()"
              title="Start release process" class="noul material-icons md-18">open_in_new</i>
            <i
              ng-show="refset.workflowStatus == 'READY_FOR_PUBLICATION' && refset.inPublicationProcess"
              ng-click="openReleaseProcessModal(refset); $event.stopPropagation()"
              title="Continue release processing"
              class="noul material-icons md-18">open_in_new</i>

            <span ng-show="refset.stagingType == 'PREVIEW'">
              <br />
              <button class="btn btn-xs btn-warning"
                ng-click="cancelAction(refset)"
                uib-tooltip="Click to cancel release process">Cancel
                Release</button>
            </span>
          </td>
        </tr>
      </tbody>
    </table>
    <!-- End R1C1 -->
  </div>

  <!-- R1C2 -->
  <div class="col-md-6 col-xs-12">

    <!-- Details, Releases, Members -->
    <span ng-show="!selected.refset && refsets.length > 0"
      class="alert alert-warning">Select a refset to see details</span>

    <div class="col-md-12 col-xs-12" ng-show="selected.refset">

      <!-- Refset Details -->
      <h4>
        <div style="float: left;">{{selected.refset.name}}</div>
        <div style="float: right;">
          <i ng-click="openNotesModal(selected.refset, 'Refset')"
            ng-show="!selected.refset.notes || selected.refset.notes.length == 0"
            title="Refset Notes" class="md-grey material-icons md-18">assignment</i>


        </div>
      </h4>
      <br /> <b>Description: </b>{{selected.refset.description}}
      <table class="table">
        <tbody>
          <tr>
            <td>Refset Id</td>
            <td>{{selected.refset.terminologyId}}</td>
          </tr>
          <tr>
            <td>Module Id</td>
            <td>
              {{selected.refset.moduleId}}
              <span flag-icon obj="selected.refset"></span>
            </td>
          </tr>
          <tr>
            <td>Organization</td>
            <td>{{selected.refset.organization}}</td>
          </tr>
          <tr ng-show="selected.refset.effectiveTime">
            <td>Effective Time</td>
            <td>{{toShortDate(selected.refset.effectiveTime)}}</td>
          </tr>
          <tr>
            <td>Terminology</td>
            <td>
              {{selected.refset.terminology}} {{selected.refset.version}}


              <i ng-click="openRefactorModel(selected.refset, 'Migration')"
                ng-show="selected.refset.stagingType == null && value == 'ASSIGNED'"
                title="Migration" class="noul material-icons md-18">find_replace</i>

              <i ng-click="openRefactorModal(selected.refset, 'Migration')"
                ng-show="selected.refset.stagingType == 'MIGRATION' && value == 'ASSIGNED'"
                title="Resume migration" class="noul material-icons md-18">play_arrow</i>

            </td>
          </tr>
          <tr ng-show="selected.refset.type == 'INTENSIONAL'">
            <td>Definition</td>
            <td>
              {{selected.refset.definition}}

              <i
                ng-click="openImportExportModal(selected.refset, 'Export', 'Definition')"
                title="Export definition" class="noul material-icons md-18">file_download</i>

              <i ng-click="openRefactorModal(selected.refset, 'Redefinition')"
                ng-show="selected.refset.stagingType == null"
                title="Redefinition" class="noul material-icons md-18">find_replace</i>

              <i ng-click="openRefactorModal(selected.refset, 'Redefinition')"
                ng-show="selected.refset.stagingType == 'DEFINITION'"
                title="Resume redefinition" class="noul material-icons md-18">play_arrow</i>
            </td>
          </tr>
          <tr ng-show="selected.refset.type == 'EXTERNAL'">
            <td>External Url</td>
            <td>{{selected.refset.externalUrl}}</td>
          </tr>
          <tr ng-show="refsetReleaseInfo && !refsetReleaseInfo.planned">
            <td ng-show="refsetReleaseInfo.published">RELEASED</td>
            <td
              ng-show="!refsetReleaseInfo.published && !refsetReleaseInfo.planned">PREVIEW</td>
            <td>{{refsetReleaseInfo.name}}
          </tr>
          <tr ng-show="!refsetReleaseInfo">
            <td>Not yet released</td>
            <td>&nbsp;</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- release info -->
    <div class="col-md-12 col-xs-12">
      <span ng-show="refsetReleaseInfo && !refsetReleaseInfo.artifacts"
        class="alert alert-warning">Release has no associated artifacts</span>
      <div class="col-md-12 col-xs-12">
        <table ng-show="refsetReleaseInfo && refsetReleaseInfo.artifacts"
          class="table">
          <thead>
            <th class="col-md-6 col-xs-6">Release File</th>
            <th class="col-md-6 col-xs-6">Timestamp</th>
            <th style="width: 1%; word-wrap: nowrap"></th>
          </thead>
          <tbody>
            <tr
              ng-repeat="artifact in refsetReleaseInfo.artifacts | orderBy:'artifact.name'">
              <td>{{artifact.name}}</td>
              <td>{{toShortDate(artifact.timestamp)}}</td>
              <td>
                <i ng-click="exportReleaseArtifact(artifact)"
                  title="Export {{artifact.name}}"
                  class="noul material-icons md-18">file_download</i>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- End R1C2 -->
  </div>

  <!-- End R1 -->
</div>

<hr ng-show="selected.refset"
  style="width: 100%; color: lightgrey; height: 1px; background-color: lightgrey;" />

<!-- R2 -->
<div class="row">

  <!-- R2C1 -->
  <div class="col-md-6 col-xs-12">

    <div ng-show="selected.member" member-info data="selected"></div>

    <!-- End R2C1 -->
  </div>

  <!-- R2C2 -->
  <div class="col-md-6 col-xs-12">

    <div class="col-md-12 col-xs-12">
      <h4 ng-show="selected.refset">
        Refset Members
        <span ng-show="selected.refset.members.totalCount>0">
          ({{selected.refset.members.totalCount}})</span>

        <div style="float: right;">

          <i
            ng-click="openImportExportModal(selected.refset, 'Export', 'Refset Members')"
            title="Export refset members" class="noul material-icons md-18">file_download</i>
          <i
            ng-show="value == 'ASSIGNED' && selected.refset.type == 'EXTENSIONAL'"
            ng-click="openImportExportModal(selected.refset, 'Import', 'Refset Members')"
            title="Import refset members" class="noul material-icons md-18">file_upload</i>
          <i ng-show="value == 'ASSIGNED'"
            ng-click="openAddMemberModal(lmember, selected.refset)"
            title="Add refset member" class="noul material-icons md-18">add</i>
          <i ng-show="value == 'ASSIGNED'"
            ng-show="selected.refset.type == 'EXTENSIONAL' && selected.refset.members.length > 0"
            ng-click="removeAllRefsetMembers(selected.refset)"
            title="Remove all members" class="noul material-icons md-18">delete</i>
        </div>
      </h4>
      <span
        ng-show="selected.refset && !paging['member'].filter && !paging['member'].typeFilter && selected.refset.members.totalCount == 0">
        <br />
        <span class="alert alert-warning">Refset has no members</span>
      </span>

      <span>
        <span style="display: block;">
          <uib-pagination items-per-page="pageSize" max-size="5"
            boundary-links="true" class="pagination-sm" previous-text="&lsaquo;"
            next-text="&rsaquo;" first-text="&laquo;" last-text="&raquo;"
            ng-show="selected.refset.members.totalCount > pageSize"
            total-items="selected.refset.members.totalCount"
            ng-model="paging['member'].page"
            ng-change="getMembers(selected.refset)"></uib-pagination>

          <input class="input-filter" placeholder="Enter filter text"
            ng-show="selected.refset.members.totalCount > pageSize || paging['member'].filter"
            type="text" ng-model="paging['member'].filter"
            ng-model-options="{ debounce: 300 }"
            ng-change="getMembers(selected.refset)">

          <button class="btn btn-xs btn-warning"
            ng-show="paging['member'].filter"
            ng-click="paging['member'].filter = ''; getMembers(selected.refset)"
            title="Click to clear filter text">Clear</button>

        </span>

        <table
          ng-show="selected.refset.members.totalCount > 0 || paging['member'].filter || paging['member'].typeFilter"
          class="table">
          <thead class="table-select-row">
            <th class="col-md-3 col-xs-3"
              ng-click="setSortField('member','conceptId', selected.refset)">Concept
              Id<span ng-bind="getSortIndicator('member','conceptId')"></span>
            </th>
            <th class="col-md-5 col-xs-5"
              ng-click="setSortField('member','conceptName', selected.refset)">Name<span
                ng-bind="getSortIndicator('member','conceptName')"></span>
            </th>
            <th ng-show="value != 'PUBLISHED' && value != 'PREVIEW'"
              class="col-md-2 col-xs-2"
              ng-click="setSortField('member','lastModified', selected.refset)">Last
              Modified<span ng-bind="getSortIndicator('member','lastModified')"></span>
            </th>
            <th ng-show="value == 'PUBLISHED' || value == 'PREVIEW'"
              class="col-md-2 col-xs-2"
              ng-click="setSortField('member','effectiveTime', selected.refset)">Effective
              Time<span ng-bind="getSortIndicator('member','effectiveTime')"></span>
            </th>
            <th class="col-md-2 col-xs-2"><select
              title="Filter by member type" style="width: 80px;"
              ng-model="paging['member'].typeFilter"
              ng-options="item for item in memberTypes"
              ng-change="getMembers(selected.refset)">
                <option value="">All</option>
            </select></th>
            <th ng-show="value == 'ASSIGNED' ">Actions</th>
          </thead>
          <tbody>
            <tr ng-repeat="member in selected.refset.members"
              ng-click="selectMember(member);"
              ng-class="{selected : member.id == selected.member.id}">
              <td>{{member.conceptId}}</td>
              <td ng-class="getMemberStyle(member)">{{member.conceptName}}</td>
              <td ng-show="value != 'PUBLISHED' && value != 'PREVIEW'">{{toDate(member.lastModified)}}</td>
              <td ng-show="value == 'PUBLISHED' || value == 'PREVIEW'">{{toShortDate(member.effectiveTime)}}</td>
              <td>
                <button class="btn btn-xs btn-primary"
                  ng-show="member.memberType == 'MEMBER'" uib-tooltip="Member">M</button>
                <button class="btn btn-xs btn-danger"
                  ng-show="member.memberType == 'EXCLUSION'"
                  uib-tooltip="Exclusion">X</button>
                <button class="btn btn-xs btn-success"
                  ng-show="member.memberType == 'INCLUSION'"
                  uib-tooltip="Inclusion">I</button>
                <button class="btn btn-xs retired"
                  ng-show="!member.conceptActive" uib-tooltip="Retired">R</button>
              </td>
              <td class="nobreak"
                ng-show="value == 'ASSIGNED' || value == 'ASSIGNED_ALL'">

                <i
                  ng-show="selected.refset.type == 'INTENSIONAL' && member.memberType =='INCLUSION'"
                  ng-click="removeRefsetInclusion(selected.refset,member); $event.stopPropagation()"
                  title="Remove inclusion" class="noul material-icons md-18">delete</i>

                <i ng-show="selected.refset.type == 'EXTENSIONAL'"
                  ng-click="removeRefsetMember(selected.refset,member); $event.stopPropagation()"
                  title="Remove" class="noul material-icons md-18">delete</i>

                <i
                  ng-show="selected.refset.type == 'INTENSIONAL' && member.memberType == 'EXCLUSION'"
                  ng-click="removeRefsetExclusion(selected.refset,member); $event.stopPropagation()"
                  title="Remove exclusion" class="noul material-icons md-18">delete</i>

                <i
                  ng-show="selected.refset.type == 'INTENSIONAL' && member.memberType == 'MEMBER'"
                  ng-click="addRefsetExclusion(selected.refset, member); $event.stopPropagation()"
                  title="Add exclusion" class="noul material-icons md-18">remove_circle_outline</i>

                <i ng-click="openNotesModal(member, 'Member')"
                  ng-show="member.notes.length > 0" title="Edit member Notes"
                  class="noul material-icons md-18">assignment</i>

                <i ng-click="openNotesModal(member, 'Member')"
                  ng-show="!member.notes || member.notes.length == 0"
                  title="Add member notes" class="md-grey material-icons md-18">assignment</i>
              </td>
            </tr>
          </tbody>
        </table>
        <span
          ng-show="paging['member'].filter && selected.refset.members.totalCount == 0"
          class="alert alert-warning">
          <br />No refset members matching filter
        </span>

      </span>
    </div>

    <!-- End R2C2 -->
  </div>

  <!-- End R2 -->
</div>
