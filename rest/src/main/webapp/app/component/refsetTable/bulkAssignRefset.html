<div class="modal-header">
  <h4 style="display: inline">
    Batch {{action}} Refset
  </h4>
  <span style="float: right">
    <i class="noul glyphicon glyphicon-remove" ng-click="cancel()"></i>
  </span>
</div>

<div class="modal-body">

    <!-- Basic Refset info -->
    <table class="table">
      <thead class="table-select-row">
        <tr>
          <th class="col-md-2 col-xs-2"><span
              ng-click="setSortField('refset','terminologyId')">
              Refset Id
              <span ng-bind="getSortIndicator('refset','terminologyId')"></span>
            </span></th>
          <th class="col-md-4 col-xs-4"><span
              ng-click="setSortField('refset','name')">
              Name
              <span ng-bind="getSortIndicator('refset','name')"></span>
            </span> / <span ng-show="isDirectory() || value == 'RELEASE'">
              <span ng-click="setSortField('refset','effectiveTime')">
                Effective Time
                <span ng-bind="getSortIndicator('refset','effectiveTime')"></span>
              </span>
            </span> <span ng-show="!isDirectory() && value != 'RELEASE'">
              <span ng-click="setSortField('refset','lastModified')">
                Last Modified
                <span ng-bind="getSortIndicator('refset','lastModified')"></span>
              </span>
            </span></th>
          <!-- PUBLISHED/BETA -->
          <th ng-show="isDirectory()" class="col-md-2 col-xs-2"><span
              ng-click="setSortField('refset','moduleId')">
              Module
              <span ng-bind="getSortIndicator('refset','moduleId')"></span>
            </span> / <span title="Organization"
              ng-click="setSortField('refset','organization')">
              Org.
              <span ng-bind="getSortIndicator('refset','organization')"></span>
            </span></th>
          <th ng-show="isDirectory()" class="col-md-3 col-xs-3"><span
              ng-click="setSortField('refset','terminology')">
              Terminology
              <span ng-bind="getSortIndicator('refset','terminology')"></span>
            </span> / <span ng-click="setSortField('refset','domain')">
              Domain
              <span ng-bind="getSortIndicator('refset','domain')"></span>
            </span></th>
          <!-- NOT PUBLISHED/BETA -->
          <th ng-show="!isDirectory()" class="col-md-3 col-xs-3"><span
              title="Module" ng-click="setSortField('refset','moduleId')">
              Mod
              <span ng-bind="getSortIndicator('refset','moduleId')"></span>
            </span> / <span title="Terminology"
              ng-click="setSortField('refset','terminology')">
              Term
              <span ng-bind="getSortIndicator('refset','terminology')"></span>
            </span> / <span ng-click="setSortField('refset','domain')">
              Domain
              <span ng-bind="getSortIndicator('refset','domain')"></span>
            </span> <span ng-show="projects.role == 'ADMIN' || value == 'RELEASE'">
              /
              <span ng-click="setSortField('refset','workflowStatus')">
                Status</span>
              <span ng-bind="getSortIndicator('refset','workflowStatus')"></span>
            </span></th>
          <th class="col-md-1 col-xs-1"><select title="Filter by type"
            style="width: 80px;" ng-model="paging['refset'].typeFilter"
            ng-options="item for item in refsetTypes" ng-change="getRefsets()">
              <option value="">All</option>
          </select></th>
          <!-- Actions header -->
          <!-- PUBLISHED/BETA : no actions row -->
          <!-- not PUBLISHED/BETA -->
          <!-- <th class="col-md-2 col-xs-2" ng-show="!isDirectory()"><span
              ng-show="value == 'AVAILABLE' && projects.role != 'REVIEWER'" style="float: right;">
              <button ng-click="openAddRefsetModal(false);" title="Add refset"
                class="btn btn-xs btn-primary">Add Refset</button>
            </span></th>
             -->
          <th>
            <td class="nobreak" ng-show="value == 'AVAILABLE'">
            <i ng-show="projects.role == 'ADMIN'";
              ng-click="openBatchAssignRefsetModal('DISPLAY'); $event.stopPropagation()"
              title="Batch Assign" class="noul material-icons md-18">assignment_ind</i>
          </th>  
        </tr>
      </thead>      
      <tbody class="table-select-row">
        <tr ng-repeat="refset in refsets" ng-click="selectRefset(refset);"
          ng-class="{selected: refset.id == selected.refset.id}">
          <td style="word-break: break-word;">{{refset.terminologyId}}</td>
          <td>
            {{refset.name}}
            <span ng-show="refset.effectiveTime">
              <br />{{toSimpleDate(refset.effectiveTime)}}
            </span>
            <span ng-show="!refset.effectiveTime">
              <br />{{toDate(refset.lastModified)}}
              <span ng-show="projects.role == 'ADMIN'">
                <br />{{refset.lastModifiedBy}}
              </span>
            </span>
          </td>
          <!-- PUBLISHED/BETA -->
          <td ng-show="isDirectory()">
            <span style="word-break: break-word;" ng-show="refset.moduleId != 0">
              {{refset.moduleId}}</span>
            <span style="word-break: break-word;" ng-show="refset.moduleId == 0"
              class="md-grey">
              <small>no module id</small>
            </span>
            <span flag-icon obj="refset"></span>
            <!-- Mobile friendly line-break -->
            <br class="visible-xs-inline" />
            <span> {{refset.organization}} </span>
          </td>
          <td ng-show="isDirectory()">
            <span>{{getTerminologyName(refset.terminology)}}
              {{refset.version}} </span>
            <br />
            <span ng-show="refset.domain">{{refset.domain}} </span>
            <span ng-show="!refset.domain" class="md-grey">
              <small>no domain specified</small>
            </span>
          </td>
          <!-- not PUBLISHED/BETA -->
          <td ng-show="!isDirectory()">
            <span style="word-break: break-word;" ng-show="refset.moduleId != 0">
              {{refset.moduleId}}</span>
            <span style="word-break: break-word;" ng-show="refset.moduleId == 0"
              class="md-grey">
              <small>no module id</small>
            </span>
            <span flag-icon obj="refset"></span>
            <br />
            <span>{{getTerminologyName(refset.terminology)}}
              {{refset.version}} </span>
            <br />
            <span ng-show="refset.domain">{{refset.domain}} </span>
            <span ng-show="!refset.domain" class="md-grey">
              <small>no domain specified</small>
            </span>
            <span ng-show="projects.role == 'ADMIN' || value == 'RELEASE'">
              <br />{{refset.workflowStatus}}
            </span>
          </td>
          <td>
            <span refset-type-icon refset="refset"></span>
          </td>
          <!-- AVAILABLE actions -->
          <td class="nobreak" ng-show="value == 'AVAILABLE'">
            <i ng-click="openEditRefsetModal(refset); $event.stopPropagation()"
              title="Edit" class="noul material-icons md-18">edit</i> <i
              title="Remove"
              ng-show="!refset.staged && projects.role == 'ADMIN'"
              confirm="Are you sure you want to remove the refset ({{refset.name}})?"
              ng-click="removeRefset(refset); $event.stopPropagation()"
              class="noul material-icons md-18">delete</i>
            <!-- Assign -->
            <i ng-show="isAllowed('ASSIGN', refset)"
              ng-click="openAssignRefsetModal(refset,'ASSIGN'); $event.stopPropagation()"
              title="Assign" class="noul material-icons md-18">assignment_ind</i>
            <!-- As admin/reviewer, unassign completely and return back to pool-->
            <i
              confirm="Are you sure you want to unassign the refset ({{refset.name}})?"
              ng-show="isAllowed('UNASSIGN', refset)"
              ng-click="unassign(refset,user.userName); $event.stopPropagation()"
              title="Unassign" class="noul material-icons md-18">assignment_return</i>

             <span
              ng-show="isLookupInProgress(refset)">
              <br />
              <button class="btn btn-xs btn-warning"
                ng-click="refreshLookupProgress(refset)"
                title="Click to refresh lookup progress">
                Refresh
                <span ng-show="refsetLookupProgress[refset.id]">
                  {{refsetLookupProgress[refset.id]}}%</span>
              </button>     
            </span>
            <!-- ASSIGNED actions -->
          <td class="nobreak" ng-show="value == 'ASSIGNED'">
            <i ng-show="projects.role != 'ADMIN'"
              ng-click="openEditRefsetModal(refset); $event.stopPropagation()"
              title="Edit" class="noul material-icons md-18">edit</i> <i
              ng-show="!refset.staged"
              ng-click="removeRefset(refset); $event.stopPropagation()"
              title="Remove" class="noul material-icons md-18">delete</i> <i
              ng-click="unassign(refset, user.userName);" title="Unassign"
              class="noul material-icons md-18">assignment_return</i> <i
              ng-show="isAllowed('FEEDBACK', refset)"
              ng-click="openAssignRefsetModal(refset,'FEEDBACK'); $event.stopPropagation()"
              title="Feedback" class="noul material-icons md-18">assignment_returned</i>
            <i ng-show="isAllowed('FINISH', refset)"
              ng-click="performWorkflowAction(refset, 'FINISH', user.userName)"
              title="Finish" class="noul material-icons md-18">done</i> <i
              ng-show="isAllowed('PREPARE_FOR_PUBLICATION', refset)"
              ng-click="performWorkflowAction(refset, 'PREPARE_FOR_PUBLICATION', user.userName)"
              title="Mark ready for publication"
              class="noul material-icons md-18">open_in_new</i>
            <!-- Cancel buttons if migration in progress -->
            <span ng-show="refset.stagingType == 'IMPORT'">
              <br />
              <button class="btn btn-xs btn-warning" ng-disabled="cancelling"
                ng-click="cancelAction(refset); "
                title="Click to cancel failed import">Cancel Import</button>
            </span>
            <span ng-show="refset.stagingType == 'MIGRATION'">
              <br />
              <button class="btn btn-xs btn-warning" ng-disabled="cancelling"
                ng-click="cancelAction(refset)"
                title="Click to cancel migration">Cancel Migration</button>
            </span>
            <!-- Refresh/start buttons if lookup in progress -->
            <span
              ng-show="!refset.lookupInProgress && refset.lookupRequired">
              <br />
              <button class="btn btn-xs btn-warning"
                ng-click="startLookup(refset)" title="Click to restart lookup">Restart
                Lookup</button>               
            </span>
            <span
              ng-show="isLookupInProgress(refset)">
              <br />
              <button class="btn btn-xs btn-warning"
                ng-click="refreshLookupProgress(refset)"
                title="Click to refresh lookup progress">
                Refresh
                <span ng-show="refsetLookupProgress[refset.id]">
                  {{refsetLookupProgress[refset.id]}}%</span>
              </button>
              <br /><br />
              <button class="btn btn-xs btn-warning"
                ng-click="cancelLookup(refset)"
                title="Click to cancel the lookup process">
                Cancel Lookup
              </button>                
            </span>
          </td>
          <!-- RELEASE actions -->
          <td class="nobreak" ng-show="value == 'RELEASE'">
            <i
              ng-show="refset.workflowStatus != 'PUBLISHED' && refset.workflowStatus != 'BETA'"
              ng-click="openEditRefsetModal(refset); $event.stopPropagation()"
              title="Edit" class="noul material-icons md-18">edit</i> <i
              confirm="Are you sure you want to remove the refset ({{refset.name}})?"
              ng-show="projects.role == 'ADMIN' && !refset.staged && !refset.inPublicationProcess && (refset.workflowStatus == 'PUBLISHED' || refset.workflowStatus == 'READY_FOR_PUBLICATION')"
              ng-click="removeRefset(refset); $event.stopPropagation()"
              title="Remove" class="noul material-icons md-18">delete</i>
            <!-- TODO -->
            <i ng-show="isAllowed('ASSIGN', refset) && !refset.inPublicationProcess"
              ng-click="openAssignRefsetModal(refset,'ASSIGN'); $event.stopPropagation()"
              title="Assign" class="noul material-icons md-18">assignment_ind</i>
            <i ng-show="isAllowed('FEEDBACK', refset)"
              ng-click="openAssignRefsetModal(refset,'FEEDBACK'); $event.stopPropagation()"
              title="Feedback" class="noul material-icons md-18">assignment_returned</i>
            <!-- only if READY_FOR_PUBLICATION -->
            <i
              ng-show="refset.workflowStatus == 'READY_FOR_PUBLICATION' && !refset.inPublicationProcess"
              ng-click="openReleaseProcessModal(refset); $event.stopPropagation()"
              title="Start release process" class="noul material-icons md-18">open_in_new</i>
            <i
              ng-show="refset.workflowStatus == 'READY_FOR_PUBLICATION' && 
                        refset.inPublicationProcess"
              ng-click="openReleaseProcessModal(refset); $event.stopPropagation()"
              title="Continue release processing"
              class="noul material-icons md-18">open_in_new</i> <i
              ng-show="refset.workflowStatus == 'BETA' && 
                        refset.inPublicationProcess"
              ng-click="openReleaseProcessModalForStaged(refset); $event.stopPropagation()"
              title="Continue release processing"
              class="noul material-icons md-18">open_in_new</i>
            <span
              ng-show="refset.workflowStatus == 'READY_FOR_PUBLICATION' && 
                        refset.inPublicationProcess">
              <br />
              <button class="btn btn-xs btn-warning" ng-disabled="cancelling"
                ng-click="cancelAction(refset); $event.stopPropagation()"
                title="Click to cancel release process">Cancel Release</button>
            </span>
            <span ng-show="refset.workflowStatus == 'BETA'">
              <br />
              <button class="btn btn-xs btn-warning" ng-disabled="cancelling"
                ng-click="cancelActionForStaged(refset); $event.stopPropagation()"
                title="Click to cancel release process">Cancel Release</button>
            </span>
          </td>
        </tr>
      </tbody>
    </table>
    <span ng-show="refsets.totalCount == 0" style="display: block;"
      class="alert alert-warning">No refsets.</span>

  <table class="table">
    
    <tr>
      <td>
        <b>User</b>
      </td>
      <td ng-show="assignedUsers.length > 1" >
        <select ng-model="user" ng-options="item.name for item in assignedUsers"></select></td>
      <td ng-show="assignedUsers.length == 1">{{assignedUsers[0].userName}}</td>
    </tr>
    <tr ng-show="errors.length > 0">
      <td>&nbsp;</td>
      <td>
        <div class="alert alert-danger alert-error">
          {{errors[0]}}
          <div style="display: inline; float: right;">
            <i ng-show="errors[1]"
              title="{{error.expand ? 'Show' : 'Hide'}} long error"
              class="noul material-icons md-18"
              ng-click="error.expand = !error.expand;">attach_file</i>
          </div>
          <p ng-show="errors[1] && error.expand">
            <br />{{errors[1]}}
          </p>
        </div>
      </td>
    </tr>
  </table>
</div>

<div class="modal-footer">
  <button ng-show="action == 'ASSIGN'" class="btn btn-xs btn-primary"
    ng-click="batchAssignRefsets();">Assign</button>
  <button class="btn btn-xs btn-warning" ng-click="cancel()">Cancel</button>
</div>